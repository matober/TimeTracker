<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <!-- If IE use the latest rendering engine -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Set the page to the width of the device and set the zoon level -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>


<!--IF THE USER IS LOGGED IN, DISPLAY THE FOLLOWING -->
<% if current_user %>
    <!-- Navigation Bar-->
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <!--Displays three bars-->
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="home">TimeTracker</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Hi <%=current_user.first_name %></a></li>
            <li>
              <%= link_to 'Sign Out', sign_out_path, method: :delete %>
            </li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>

     <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
    <body>
    <!--Display Date and next/previous buttons-->
    <ul class="pager">
      <div class="dateHeading"><b><h1 align="center" id="date"></h1></b></div>
      <li class="previous"><a href="#"><span aria-hidden="true">&larr;</span>Previous </a></li>
      <li class="next"><a href="#"> Next<span aria-hidden="true">&rarr;</span></a></li>
    </ul>

    <!--Button to create activity/category-->
    <div style="padding-left: 80%">
      <button id="CreateButton" style="background-color: transparent; border: none">
        <i class="fa fa-plus-circle fa-2x" aria-hidden="true" style="color: green"><span style="color: black"> Create</span></i>
      </button>
    </div>

    <!--Categories Heading-->
    <h3 style="padding-left: 3%"><u>My Categories</u></h3>

    <!--Display Categories-->
    <div id = "theCategories">
      <ul id="Categories" class="connectedSortable">
        <!--Loop through categories in database-->
        <% @categories.each do |cats| %>

            <!--Display only categories belonging to the user-->
            <% if cats.user_id == current_user.id %>

                <!--Link category to its id, needed for hide and destroy js-->
                <div id="edit_category_<%= cats.id%>">

                  <!--Create panels to store activities-->
                <div class="panel-group">
                  <div class="panel text-left">
                    <div class="panel-heading" id='<%=cats.id%>'>
                      <h4 class="panel-title">

                        <!--Collapsible Panel linked to div "collapse" where ID specifies which
                            panel gets toggled to collapse or expand-->
                        <a data-toggle="collapse" href="#collapse<%= cats.id%>">
                          <%= cats.c_name %>

                          <!-- Link to destroy category path to delete category -->
                          <%= link_to destroy_cat_path(cats.id), method: :delete,
                                      data: { confirm: 'Warning! Deleting this category will delete all activities associated with it. Would you like to continue?' }, remote: true do %>
                              <!--Set trashcan icon as delete link_to-->
                              <i class="fa fa-trash-o" aria-hidden="true" title="Delete" style="padding-left: 2%;color: darkblue"></i>
                          <% end %>

                          <!--Link to edit category path to edit category -->
                          <%= link_to edit_cat_path(cats.id), remote:true do %>
                              <!--Set pencil icon as edit link_to-->
                              <i class="fa fa-pencil fa-fw" aria-hidden="true" title="Edit" id="editCategory" style="color: darkblue"></i>
                          <% end %>

                          <!--Link to unhide category path to unhide category-->
                          <%= link_to unhide_cat_path(cats.id), method: :post,remote: true do %>
                              <!--Set eye icon as unhide link_to-->
                              <i class="fa fa-eye" aria-hidden="true" title="Show Hidden" style="border:none; background-color: transparent; padding:0; color: darkblue"></i>
                          <% end %>
                        </a>
                      </h4>
                    </div>

                    <!--Each panel needs to have a unique ID so the collapsible knows
                        which div to expand or collapse-->
                    <div id="collapse<%= cats.id%>" class="panel-collapse collapse">
                      <!--Give id to category with activities, used for destroy js-->
                      <ul id="category_activities<%=cats.id%>" class="activitiesWithCat">

                        <!--Loop through each activity within category-->
                        <% cats.activities.each do |activity| %>

                            <!--Display activities that are not hidden-->
                            <% if activity.hidden == false || activity.hidden == nil%>
                                <!--Give id to activities inside of category, used for hide js-->
                                <div id="edit_activity_<%= activity.id%>">

                                  <!--Display activities, pass activity id to enable sorting-->
                                  <li class="list-group-item" id='<%=activity.id%>'>

                                    <!--Display activity name -->
                                    <label class="my_label"><%= activity.a_name %></label>

                                    <!-- Link to delete activity path to delete activity -->
                                    <%= link_to destroy_act_path(activity.id), method: :delete,
                                                data: { confirm: "Are you sure?" }, remote: true do %>
                                        <!--Set trash can icon to destroy link_to-->
                                        <i class="fa fa-trash-o" aria-hidden="true" title="Delete" style="padding-left: 2%"></i>
                                    <% end %>

                                    <!-- Link to edit activity path to edit activity -->
                                    <%= link_to edit_act_path(activity.id), remote: true do %>
                                        <!--Set pencil icon to edit link_to-->
                                        <i class="fa fa-pencil fa-fw" aria-hidden="true" title="Edit" id="editActivity"></i>
                                    <% end %>

                                    <!-- Link to hide activity path to hide activity -->
                                    <%= link_to hide_act_path(activity.id),method: :post, remote: true do %>
                                        <!--Set eye slash icon to hide link_to-->
                                        <i class="fa fa-eye-slash" aria-hidden="true" title="Hide" id="item"></i>
                                    <% end %>

                                    <!--######################MABYE DELETE? #########################-->
                                     <!--THIS IS TO DISPLAY TOTAL TIME -->
                                    <!--<div id="total_time<%=activity.id%>">-->
                                    <!--<p class = 'total_time_display'><%=activity.total_time%> minutes</p>-->
                                    <!--</div>-->


                                     <!--&lt;!&ndash;CODE TO DYNAMICALLY CREATE BUTTONS WITH UNIQUE IDS &ndash;&gt;-->
                                    <!--<div class="scroll-pane">-->
                                    <!--<% (0..12).each do |am| %>-->
                                        <!--<% if am < 12 %>-->
                                            <!--<label><%=am%>:00 AM</label>-->
                                            <!--<% (1..4).each do |amID| %>-->
                                                <!--<button class = 'unfilled', id = 'timeAct<%=activity.id%><%=am%><%=amID%>', onclick="changeImages(this.id,<%=activity.id%>)">-->
                                                <!--</button>-->
                                                <!--<% end %>-->
                                            <!--<% else %>-->
                                            <!--<label><%=am%>:00 PM</label>-->
                                            <!--<% (1..4).each do |amID| %>-->
                                                <!--<button class = 'unfilled', id = 'timeAct<%=activity.id%><%=am%><%=amID%>', onclick="changeImages(this.id,<%=activity.id%>)">-->
                                                <!--</button>-->
                                                <!--<% end %>-->
                                            <!--<% end %>-->

                                        <!--<% end %>-->

                                    <!--<% (13..23).each do |pm| %>-->
                                        <!--<label><%=pm-12%>:00 PM</label>-->
                                        <!--<% (1..4).each do |pmID| %>-->
                                            <!--<button class = 'unfilled', id = 'timeAct<%=activity.id%><%=pm%><%=pmID%>', onclick="changeImages(this.id)">-->
                                            <!--</button>-->
                                            <!--<% end %>-->
                                        <!--<% end %>-->
                                    <!--</div>-->

                                  </li>
                                </div>
                            <% end %> <!--End of hidden if statement-->
                      <% end %> <!--End of activities loop-->
                      </ul>
                    </div>
                  </div>
                </div>
                </div>
            <% end %> <!--End of user if statement-->
        <% end %> <!--End of categories loop-->
      </ul>
    </div>

    <!--Activities without categories-->
    <h3 style="padding-left: 2.5%"><u>Other Activities</u>

      <!--Link to unhide path to show hidden activities-->
      <%= link_to unhide_act_path, method: :post,remote: true do %>
          <button class="showHidden" style="border:none; background-color: transparent">
            <!--Set eye icon to unhide link_to-->
            <i class="fa fa-eye" aria-hidden="true" title="Show Hidden" style="border:none; background-color: transparent; color: black"></i>
          </button>
      <% end %>
    </h3>

    <!--Display activities with no category-->
    <div id="theActivities">
      <ul id="Activities" class="connectedSortable" >

        <!-- Display each activity in database -->
        <% @activities.each do |activity| %>
            <!--Check if activity is not hidden and does not a part of a category-->
            <% if (activity.hidden == false || activity.hidden == nil) && activity.category_id == nil %>

                <!--Display only categories belonging to the user-->
                <% if(activity.user_id == current_user.id) %>

                    <!--Pass activity id, used for hide and destroy js-->
                    <div id="edit_activity_<%= activity.id%>">
                      <!--Pass activity id, used for sortable-->
                      <li class="list-group-item" id='<%=activity.id%>' style="list-style: none;">
                        <!-- Display activity name -->
                        <label class="my_label"><%= activity.a_name %></label>

                        <!-- Link to delete activity path to delete activity -->
                        <%= link_to destroy_act_path(activity.id), method: :delete,
                                    data: { confirm: "Are you sure?" }, remote: true do %>
                            <!--Set trash can icon to delete link_to-->
                            <i class="fa fa-trash-o" aria-hidden="true" title="Delete" style="padding-left: 2%"></i>
                        <% end %>

                        <!-- Link to edit activity path to edit activity-->
                        <%= link_to edit_act_path(activity.id), remote: true do %>
                            <button class="editActivity" style="border:none; padding:0; background-color: transparent">
                              <!--Set pencil icon to edit link_to-->
                              <i class="fa fa-pencil fa-fw" aria-hidden="true" title="Edit" id="editActivity"></i>
                            </button>
                        <% end %>

                        <!-- Link to hide activity path to hide activity -->
                        <%= link_to hide_act_path(activity.id),method: :post, remote: true do %>
                            <button class="hideActivity" style="border:none; padding:0; background-color: transparent">
                              <!--Set eye slash icon to hide link_to-->
                              <i class="fa fa-eye-slash" aria-hidden="true" title="Hide" id="item"></i>
                            </button>
                        <% end %>

                        <!--############### MAY NEED TO DELETE ##################-->
                         <!--CODE TO DYNAMICALLY CREATE BUTTONS WITH UNIQUE IDS -->
                        <!--<label class="scroll-pane">-->
                        <!--<% (0..12).each do |am| %>-->
                            <!--<% if am < 12 %>-->
                                <!--<label><%=am%>:00 AM</label>-->
                                <!--<% (1..4).each do |amID| %>-->
                                    <!--<button class = 'unfilled', id = 'timeAct<%=activity.id%><%=am%><%=amID%>', onclick="changeImages(this.id,<%=activity.id%>)">-->
                                    <!--</button>-->
                                    <!--<% end %>-->
                                <!--<% else %>-->
                                <!--<label><%=am%>:00 PM</label>-->
                                <!--<% (1..4).each do |amID| %>-->
                                    <!--<button class = 'unfilled', id = 'timeAct<%=activity.id%><%=am%><%=amID%>', onclick="changeImages(this.id,<%=activity.id%>)">-->
                                    <!--</button>-->
                                    <!--<% end %>-->
                                <!--<% end %>-->

                            <!--<% end %>-->

                        <!--<% (13..23).each do |pm| %>-->
                            <!--<label><%=pm-12%>:00 PM</label>-->
                            <!--<% (1..4).each do |pmID| %>-->
                                <!--<button class = 'unfilled', id = 'timeAct<%=activity.id%><%=pm%><%=pmID%>', onclick="changeImages(this.id)">-->
                                <!--</button>-->
                                <!--<% end %>-->
                            <!--<% end %>-->
                        <!--</label>-->
                        <!--&lt;!&ndash; THIS IS TO DISPLAY TOTAL TIME &ndash;&gt;-->
                        <!--<label id="total_time<%=activity.id%>" class ='total_time_display'><%=activity.total_time%> minutes</label>-->
                    <!--#######################################################################-->

                      </li> <!-- End of list item -->
                    </div>
                <% end %> <!--End of user if statement-->
            <% end %> <!-- End of hidden if statement -->
        <% end %> <!-- End of activity loop -->
      </ul>
    </div>

    <!--Set forms for creating activities and categories to hidden -->
    <div id="form" hidden="true" style="padding-left: 3%">

      <!--Create activity-->
        <%= form_for @activity, :url => create_act_path, remote: true do |a| %>
            <%= a.text_field :a_name, id: 'a_name_field', placeholder: ' Activity Name'%> <!--Input for activity name-->

            <!--Assign a category to an activity
                We use a drop down list to allow the selection of a category
                We also allow the assigning of no category-->
            <%= a.select :category_id,
                         Category.where(:user_id => current_user.id).collect {|c| [c.c_name, c.id]}, include_blank: '--No Category--' %>

            <!--Submit button to create activity-->
            <%= a.submit 'Create', id: 'submitButton', class: 'btn btn-primary'%>
        <% end %>

      <!--The form for creating a category -->
      <%= form_for @category, :url => create_cat_path, remote: true do |c| %>
          <!--Text field to input category name-->
          <%= c.text_field :c_name, id: 'c_name_field', placeholder: ' Category Name'%>
          <!--Button to submit the inputs and create a category-->
          <%= c.submit 'Create', id: 'submitButton', class: 'btn btn-primary'%>
      <% end %>
    </div>

    <!--Render the edit form of an activity-->
    <div id = 'editContainer', align="center"></div>

    <!--Render the edit form of a category-->
    <div id = 'editCatContainer', align="center"></div>
    </body>


    <!-- IF THE USER IS NOT LOGGED IN, DISPLAY THE FOLLOWING -->
<% else %>

    <!--Navigation bar-->
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <!-- Brand and toggle get grouped for better mobile display -->
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">TimeTracker</a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li class="active">
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!--Display the welcome message-->
    <div class="loginContainer" align="center">
      <h1 align="center">
        <b>
          Welcome to the Time Tracker App <br><h2>Please log in or sign up</h2>
        </b>
      </h1>

      <!--Buttons to login or signup-->
      <div class="container">
        <br>
        <!--Button to take the user to the login page via path-->
        <%= button_to 'Login', sign_in_path, :method => 'get', class: 'btn' %>
        <br>

        <!--Button to take the user to the signup page via path-->
        <%= button_to 'Sign Up', sign_up_path, :method => 'get', class: 'btn' %>
      </div>
    </div>
<% end %>

<script>
//  Show create new activity and category forms
    $('#CreateButton').click(function(e){
        e.preventDefault(); //to prevent standard click event
        $('#form').toggle();
    });

    //    Display current day
    var d = new Date();
    var days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    document.getElementById("date").innerHTML = (days[d.getUTCDay()]  + ", " + months[d.getUTCMonth()] + " " + d.getUTCDate() + ", " + d.getUTCFullYear());

    //call function to keep track of sorted activity positions
    $(document).ready(function(){
        callAll();
    });

    //Save sorted activities position
    function callAll(){
        var ready, set_positions;
        set_positions = function(){
            // loop through and give each task a data-pos
            // attribute that holds its position in the DOM
            $('.list-group-item').each(function(i){
                $(this).attr("data-pos",i+1);
            });
        }

        //call function to save positions
        set_positions();
        //Make activities without categories sortable
        $('#Activities').sortable();
        $('#Activities').disableSelection();
        //Make categories sortable
        $('#Categories').sortable();
        $('#Categories').disableSelection();
        //Make activities under a category sortable
        $('.activitiesWithCat').sortable();
        $('.activitiesWithCat').disableSelection()

        // Save new sorted position (activities without a category)
        $('#Activities').sortable().bind('sortupdate', function(e, ui) {
            // array to store new order
            var updated_order = []
            // set the updated positions
            set_positions();
            // push new position into array
            $('#Activities li').each(function(i){
                updated_order.push({ id: $(this).attr('id'), position: i });
            });
            // send the updated order via ajax
            $.ajax({
                type: "PUT",
                url: '/home/sort',
                dataType: 'json',
                data: { order: updated_order }
            });
        });

        // Save new sorted position (Categories) --Does not currently work
        $('#Categories').sortable().bind('sortupdate', function(e, ui) {
            // array to store new order
            var updated_order = []
            // set the updated positions
            set_positions();
            // push new position into array
            $('#Categories li').each(function(i){
                updated_order.push({ id: $(this).attr('id'), position: i });
            });
            // send the updated order via ajax
            $.ajax({
                type: "PUT",
                url: '/home/sort',
                data: { order: updated_order }
            });
        });

        // Save new sorted position (activities with category)
        $('.activitiesWithCat').sortable().bind('sortupdate', function(e, ui) {
            // array to store new order
            var updated_order = []
            // set the updated positions
            set_positions();
            // push new positions into array
            $('.activitiesWithCat li').each(function(i){
                updated_order.push({ id: $(this).attr('id'), position: i });
            });
            // send the updated order via ajax
            $.ajax({
                type: "PUT",
                url: '/home/sort',
                data: { order: updated_order }
            });
        });
    }
</script>

<!--############MAY NEED TO DELETE ##########################-->
<!--BELOW IS THE CODE USED TO SWITCH THE STATE OF BUTTONS AND THE AJAX CALL TO UPDATE TIME-->
<script>
//      function changeImages(img,act_id){
//        var element = document.getElementById(img);
//        if (element.className == 'unfilled'){
//            element.className = 'filled';
//
//            $.ajax({
//                type: "POST",
//                url: '/activity/increase/' + act_id
//            });
//        }
//        else{
//            element.className = 'unfilled';
//
//            $.ajax({
//                type: "POST",
//                url: '/activity/decrease/' + act_id
//            });
//        }
//      }
//
//      $(document).ready(function () {
//          $(function()
//          {
//              $('.scroll-pane').jScrollPane();
//          });
//      });

</script>
<!--################################-->

<style>
  /*Place create activity and category forms on same line*/
  form{
    display: inline-block;
    padding-bottom: 5%;
  }

  /*Set list item width*/
  li.list-group-item {
    width: 95%;
  }

  /*Create border around current date*/
  .dateHeading{
    margin: 0 auto;
    border-radius: 25px;
    border-style: solid;
    border-color: darkblue;
    padding: 10px;
    width: 50%;
  }

  /*Remove extra space from collapsible panels*/
  .panel-group {
    margin: 0 !important;
    padding:0 !important;
  }

  /*Change every other list item color*/
  li.list-group-item:nth-child(even) {background: lightgray}

  /*############MAY NOT NEED ###################*/
    /*.scroll-pane{*/
      /*width: 65%;*/
      /*padding-left: 40%;*/
    /*}*/
    /*.total_time_display{*/
      /*float:right;*/
    /*}*/
    /*###########################################*/
</style>
</html>